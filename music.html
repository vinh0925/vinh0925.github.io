<!doctype html>

<html>
<head>
	<style type="text/css">
		h1 {color:#336600;
			font-family:"Comic Sans MS";
			}
		p {
			line-height:140%;
			text-indent:20px;
		}
		ol {
			font-weight:bold;
		}
		ul {
			font-style:italic;
		}
		h1 {text-align:center;}
		body {background-color:darkslategray;
		color:white;
		};
		canvas {
			position:absolute;
			top:50%;
			left:50%;
			transform: translate(-50%, -50%)
		}
		
	</style>
	<title> Web Audio</title>
</head>

<body>
<h1>sound</h1>
    <audio src="Classique.mp3" type="audio/mpeg">
        browser do not support audio
	</audio>
<button data-playing="false" role="switch" aria-checked="false">
	<span>Play/Pause</span>
</button>
<input type="range" id="volume" min ="0" max="2" value="1" step="0.05">
<canvas id="scene"></canvas>
</body>
<script type="text/javascript">
    const audioContext =  new AudioContext();
    const audioElement = document.querySelector("audio");
    const track = audioContext.createMediaElementSource(audioElement);
    track.connect(audioContext.destination);
	var analyser = audioContext.createAnalyser();
	track.connect(analyser);


	analyser.fftSize = 256;
	var bufferLength = analyser.frequencyBinCount;
	console.log(bufferLength);
	var dataArray = new Uint8Array(bufferLength);
	
	var canvas = document.getElementById("scene");
	var canvasCtx = canvas.getContext('2d');
	canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
	
	//draw
	function draw(){
		drawVisual = requestAnimationFrame(draw);

		analyser.getByteFrequencyData(dataArray);

		canvasCtx.fillStyle = 'rgb(0, 0, 0)';
		canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
		var barWidth = (canvas.width / bufferLength) * 2.5;
		var barHeight;
		var x = 0;

		for (var i = 0; i < bufferLength; i++) {
			barHeight = dataArray[i];

			canvasCtx.fillStyle = 'rgb(' + (barHeight + 100) + ', 50,50)';
			canvasCtx.fillRect(x, canvas.height - barHeight/2, barWidth, barHeight);
			x += barWidth + 1;
		}
	}


	const playButton = document.querySelector('button');

	playButton.addEventListener('click', function() {
		if (audioContext.state === 'suspended') {
			audioContext.resume();
		}

		if (this.dataset.playing === 'false') {
			audioElement.play();
			this.dataset.playing = 'true';
		}
		else if(this.dataset.playing === 'true') {
			audioElement.pause();
			this.dataset.playing = 'false';
		}
		
	}, false);

	audioElement.addEventListener('ended', () => {
		playButton.dataset.playing = 'false';
	}, false);

	const gainNode = audioContext.createGain();
	track.connect(gainNode).connect(audioContext.destination);

	const volumeControl = document.querySelector('#volume');

	volumeControl.addEventListener('input', function() {
		gainNode.gain.value = this.value;
	})

	draw();
</script>
</html>